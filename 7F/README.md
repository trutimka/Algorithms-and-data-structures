Для быстрых ответов на запросы сведем задачу к RMQ. Для это этого обойдем дерево DFS и для каждой вершины проставим высоту, считая от корня, а также запомним весь обход (массив order), добавляя высоту вершины при каждом попадании в эту вершину. Дополнительно запомним первое упоминание вершины (словарь first_in) в полном обходе (массив order). После строим расзряженную таблицу. Рассмотрим обработку запроса: мы берем интервал из всего обхода (массив order), границами будет первые упоминания данных вершин (значения из массива first_in) и через разряженную таблицу получаем высоту наименьшего общего предка для вершин. Выводим сумму разниц между высотами каждой из вершин и высоты общего предка.